<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pubblica Annuncio - UniMarket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script>
        (function(){
            try{
                const tema = localStorage.getItem('temaPreferito') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                document.documentElement.setAttribute('data-bs-theme', tema);
            }catch(e){console.warn('Impossibile applicare tema:', e)}
        })();
    </script>
    <script>
        // Applica classi dei pulsanti in base al tema (light/dark)
        (function(){
            function applyButtonTheme(theme){
                const pub = document.getElementById('btn-pubblica');
                const ann = document.getElementById('btn-annulla');
                if(!pub || !ann) return;
                if(theme === 'dark'){
                    pub.classList.remove('btn-dark'); pub.classList.add('btn-light');
                    ann.classList.remove('btn-outline-dark'); ann.classList.add('btn-outline-light');
                } else {
                    pub.classList.remove('btn-light'); pub.classList.add('btn-dark');
                    ann.classList.remove('btn-outline-light'); ann.classList.add('btn-outline-dark');
                }
            }

            function initApply(){
                const initialTheme = document.documentElement.getAttribute('data-bs-theme') || localStorage.getItem('temaPreferito') || 'light';
                applyButtonTheme(initialTheme);
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initApply);
            } else {
                initApply();
            }

            window.addEventListener('storage', (e) => {
                if (e.key === 'temaPreferito') {
                    const t = e.newValue || 'light';
                    document.documentElement.setAttribute('data-bs-theme', t);
                    applyButtonTheme(t);
                }
            });

            const obs = new MutationObserver(() => {
                const t = document.documentElement.getAttribute('data-bs-theme') || 'light';
                applyButtonTheme(t);
            });
            obs.observe(document.documentElement, { attributes: true, attributeFilter: ['data-bs-theme'] });
        })();
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="style/style.css">
    <style>
        .img-preview { width: 100%; height: 140px; object-fit: cover; border-radius: 6px; }
        .preview-card { width: 140px; }
        .preview-list { gap: .75rem; }
        @media (max-width: 575.98px) {
            .preview-card { width: 100px; }
        }
    </style>
</head>

<body class="bg-body-tertiary">

    <header class="container-fluid bg-body border-bottom">
        <div class="container-fluid d-flex align-items-center gap-3 p-2">
            <a href="index.html" class="btn btn-link text-body p-0" aria-label="Torna al menu">
                <i class="bi bi-arrow-left fs-4"></i>
            </a>
            <div>
                <h1 class="h5 mb-0 fw-bold">Pubblica un annuncio</h1>
                <small class="text-muted">Vendi i tuoi libri ed appunti universitari</small>
            </div>
        </div>
    </header>
 
    <main class="container my-4">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">
                <form id="form-annuncio" class="needs-validation card bg-body border p-4 shadow-sm" novalidate>

                    <div class="mb-3">
                        <label for="titolo" class="form-label">Titolo annuncio</label>
                        <input type="text" class="form-control" id="titolo" name="titolo" required>
                        <div class="invalid-feedback">Inserisci il titolo dell'annuncio.</div>
                    </div>

                    <div class="mb-3">
                        <label for="descrizione" class="form-label">Descrizione</label>
                        <textarea class="form-control" id="descrizione" name="descrizione" rows="5" required></textarea>
                        <div class="invalid-feedback">Inserisci una descrizione.</div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-6 col-md-4">
                            <label for="prezzo" class="form-label">Prezzo</label>
                            <input type="number" class="form-control" id="prezzo" name="prezzo" min="0" step="0.01" required>
                            <div class="invalid-feedback">Inserisci un prezzo valido.</div>
                        </div>
                        <div class="col-6 col-md-4">
                            <label for="tipo" class="form-label">Tipo</label>
                            <select id="tipo" name="tipo" class="form-select" required>
                                <option value="">Scegli...</option>
                                <option>Vendita</option>
                                <option>Scambio</option>
                                <option>Regalo</option>
                            </select>
                            <div class="invalid-feedback">Seleziona il tipo.</div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="condizioni" class="form-label">Condizioni</label>
                            <select id="condizioni" name="condizioni" class="form-select">
                                <option>Nuovo</option>
                                <option>Usato - ottimo</option>
                                <option>Usato - buono</option>
                                <option>Usato - accettabile</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-12 col-md-6">
                            <label for="corso" class="form-label">Corso di studio</label>
                            <input id="corso" name="corso" class="form-control" placeholder="Es. Informatica" required>
                            <div class="invalid-feedback">Inserisci il corso di studio.</div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="facolta" class="form-label">Facoltà</label>
                            <input id="facolta" name="facolta" class="form-control" placeholder="Es. Ingegneria" required>
                            <div class="invalid-feedback">Inserisci la facoltà.</div>
                        </div>
                    </div>

                    <hr>

                    <div class="mb-3">
                        <label class="form-label">Immagini prodotto (inserisci URL)</label>
                        <div class="d-flex gap-2">
                            <input id="image-url-input" class="form-control" placeholder="https://.../immagine.jpg" aria-label="URL immagine">
                            <button type="button" id="btn-aggiungi-immagine" class="btn btn-outline-primary">Aggiungi</button>
                        </div>
                        <div class="form-text">Puoi aggiungere più URL; appariranno anteprime qui sotto.</div>
                    </div>

                    <div id="preview-row" class="d-flex flex-row flex-wrap preview-list mt-3"></div>

                    <div class="mt-4 d-grid gap-2">
                        <a id="btn-annulla" href="index.html" class="btn btn-outline-dark w-100">Annulla</a>
                        <button id="btn-pubblica" type="submit" class="btn btn-dark w-100">Pubblica annuncio</button>
                    </div>

                </form>
            </div>

        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function () {
            'use strict'
            const forms = document.querySelectorAll('.needs-validation')
            Array.from(forms).forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    } else {
                        event.preventDefault();
                        const data = new FormData(form);
                        const images = Array.from(document.querySelectorAll('.preview-card img')).map(img => img.src);
                        const payload = {
                            titolo: data.get('titolo'),
                            descrizione: data.get('descrizione'),
                            prezzo: data.get('prezzo'),
                            tipo: data.get('tipo'),
                            condizioni: data.get('condizioni'),
                            corso: data.get('corso'),
                            facolta: data.get('facolta'),
                            immagini: images
                        };
                        console.log('Dati annuncio:', payload);
                        alert('Annuncio pubblicato (simulazione). Controlla la console per i dati.');
                    }
                    form.classList.add('was-validated')
                }, false)
            })
        })()

        const btnAggiungi = document.getElementById('btn-aggiungi-immagine');
        const inputUrl = document.getElementById('image-url-input');
        const previewRow = document.getElementById('preview-row');

        function isValidUrl(string) {
            try { return Boolean(new URL(string)); }
            catch(e){ return false; }
        }

        function creaPreview(url) {
            const wrapper = document.createElement('div');
            wrapper.className = 'preview-card card p-2 border-0';
            wrapper.style.width = '';

            const img = document.createElement('img');
            img.src = url;
            img.alt = 'Anteprima immagine';
            img.className = 'img-preview mb-2';

            const btnRemove = document.createElement('button');
            btnRemove.type = 'button';
            btnRemove.className = 'btn btn-sm btn-outline-danger w-100';
            btnRemove.textContent = 'Rimuovi';
            btnRemove.addEventListener('click', () => wrapper.remove());

            wrapper.appendChild(img);
            wrapper.appendChild(btnRemove);
            return wrapper;
        }

        btnAggiungi.addEventListener('click', () => {
            const url = inputUrl.value.trim();
            if (!url) return;
            if (!isValidUrl(url)) { alert('URL non valido'); return; }
            const preview = creaPreview(url);
            previewRow.appendChild(preview);
            inputUrl.value = '';
            inputUrl.focus();
        });

        inputUrl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); btnAggiungi.click(); }
        });
    </script>

</body>
</html>